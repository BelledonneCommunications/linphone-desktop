FROM gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos:8

MAINTAINER Peio Rigaux <peio.rigaux@belledonne-communications.com>

#Tools for QT buid script
#python3-devel and pathfix.py are used to fix outdated python shebangs in qt scripts
RUN sudo dnf install -y python3 pigz

#QT Dependencies
RUN sudo dnf install -y dnf-plugins-core && sudo dnf config-manager -y --set-enabled PowerTools && sudo dnf install -y libxkbcommon* libxcb jasper-devel && sudo ln -s /usr/bin/python3 /usr/bin/python

# Build qt5.12.5
RUN git clone -b fix/qt5_build_issues_new_docker_images --single-branch https://gitlab.linphone.org/BC/public/linphone-desktop.git && \
    ./linphone-desktop/tools/build_qt_rpm && \
    sudo rpm -i ./linphone-desktop/rpm-linphone-qt-5.12.5/rpmbuild/RPMS/x86_64/*.rpm && \
    sudo mv ./linphone-desktop/rpm-linphone-qt-5.12.5/rpmbuild/RPMS/x86_64/*.rpm / && \
    rm -rf ./linphone-desktop

# Configure user bc
RUN useradd -ms /bin/bash bc && \
    echo 'bc:cotcot' | chpasswd && \
    echo 'bc ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

ENV Qt5_DIR=/opt/com.belledonne-communications/linphone/lib/cmake
ENV PATH=$PATH:/opt/com.belledonne-communications/linphone/bin

USER bc
WORKDIR /home/bc
ENV PS1='\[\e[34m\]\u@bc-dev-centos7>\[\e[0m\] '
CMD bash
